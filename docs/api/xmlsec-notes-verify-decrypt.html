<HTML
><HEAD
><TITLE
>Verifing and decrypting documents.</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.76b+
"><LINK
REL="HOME"
TITLE="XML Security Library Reference Manual"
HREF="index.html"><LINK
REL="UP"
TITLE="XML Security Library Programming Notes"
HREF="xmlsec-notes.html"><LINK
REL="PREVIOUS"
TITLE="Signing and encrypting documents."
HREF="xmlsec-notes-sign-encrypt.html"><LINK
REL="NEXT"
TITLE="Creating dynamic templates."
HREF="xmlsec-notes-templates.html"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
BGCOLOR="#000000"
CELLPADDING="1"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="5"
>XML Security Library Reference Manual</FONT
></TH
></TR
><TR
><TD
WIDTH="25%"
BGCOLOR="#C00000"
ALIGN="left"
><A
HREF="xmlsec-notes-sign-encrypt.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>&#60;&#60;&#60; Previous Page</B
></FONT
></A
></TD
><TD
WIDTH="25%"
BGCOLOR="#0000C0"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
><A
HREF="index.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Home</B
></FONT
></A
></B
></FONT
></TD
><TD
WIDTH="25%"
BGCOLOR="#00C000"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
><A
HREF="xmlsec-notes.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Up</B
></FONT
></A
></B
></FONT
></TD
><TD
WIDTH="25%"
BGCOLOR="#C00000"
ALIGN="right"
><A
HREF="xmlsec-notes-templates.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Next Page &#62;&#62;&#62;</B
></FONT
></A
></TD
></TR
></TABLE
></DIV
><BR
CLEAR="all"><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="XMLSEC-NOTES-VERIFY-DECRYPT"
></A
>Verifing and decrypting documents.</H1
><P
>Since the template is just an XML file, it might be created in advance 
	and saved in a file. It's also possible for application to create 
	templates without using XML Security Library functions. Also in some 
	cases template should be inserted in the signed or encrypted data 
	(for example, if you want to create an enveloped or enveloping 
	signature).</P
><P
>Signature verification and data decryption do not require template 
	because all the necessary information is provided in the signed or 
	encrypted document.
    	  <DIV
CLASS="FIGURE"
><A
NAME="AEN133"
></A
><P
><B
>Figure 3. The verification or decryption processing model.</B
></P
><P
><IMG
SRC="images/verif-dec-model.png"
ALIGN="CENTER"></P
></DIV
>	 
	</P
><P
>The typical siganture verification process includes following steps:
	  <P
></P
><UL
><LI
><P
>		Load keys, X509 certificates, etc. in the <A
HREF="xmlsec-keysmngr.html#XMLSECKEYSMNGR"
>keys manager</A
> .
	    </P
></LI
><LI
><P
>		Create signature context <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTX"
>xmlSecDSigCtx</A
>
		using <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXCREATE"
>xmlSecDSigCtxCreate</A
> or
		<A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXINITIALIZE"
>xmlSecDSigCtxInitialize</A
>
		functions.
	    </P
></LI
><LI
><P
>		Select start verification &lt;dsig:Signature/&gt; node in 
		the signed XML document.
	    </P
></LI
><LI
><P
>		Verify signature by calling <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXVERIFY"
>xmlSecDSigCtxVerify</A
> 
		function.
	    </P
></LI
><LI
><P
>		Check returned value and verification status (<TT
CLASS="STRUCTFIELD"
><I
>status</I
></TT
>
		member of <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTX"
>xmlSecDSigCtx</A
> structure).
		If necessary, consume returned data from the <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTX"
>context</A
>.
	    </P
></LI
><LI
><P
>		Destroy signature context <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTX"
>xmlSecDSigCtx</A
>
		using <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXDESTROY"
>xmlSecDSigCtxDestroy</A
> or
		<A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXFINALIZE"
>xmlSecDSigCtxFinalize</A
>
		functions.
	    </P
></LI
></UL
>
	</P
><P
>	     <DIV
CLASS="EXAMPLE"
><A
NAME="AEN162"
></A
><P
><B
>Example 5. Verifying a document.</B
></P
><TABLE
BORDER="0"
BGCOLOR="#D8F8D8"
WIDTH="100%"
CELLPADDING="6"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>int 
verify_file(const char* xml_file, const char* key_file) {
    xmlDocPtr doc = NULL;
    xmlNodePtr node = NULL;
    xmlSecDSigCtxPtr dsigCtx = NULL;
    int res = -1;
    
    assert(xml_file);
    assert(key_file);

    /* load file */
    doc = xmlParseFile(xml_file);
    if ((doc == NULL) || (xmlDocGetRootElement(doc) == NULL)){
	fprintf(stderr, "Error: unable to parse file \"%s\"\n", xml_file);
	goto done;	
    }
    
    /* find start node */
    node = xmlSecFindNode(xmlDocGetRootElement(doc), xmlSecNodeSignature, xmlSecDSigNs);
    if(node == NULL) {
	fprintf(stderr, "Error: start node not found in \"%s\"\n", xml_file);
	goto done;	
    }

    /* create signature context, we don't need keys manager in this example */
    dsigCtx = xmlSecDSigCtxCreate(NULL);
    if(dsigCtx == NULL) {
        fprintf(stderr,"Error: failed to create signature context\n");
	goto done;
    }

    /* load public key */
    dsigCtx-&#62;signKey = xmlSecCryptoAppPemKeyLoad(key_file, NULL, NULL, 0);
    if(dsigCtx-&#62;signKey == NULL) {
        fprintf(stderr,"Error: failed to load public pem key from \"%s\"\n", key_file);
	goto done;
    }

    /* Verify signature */
    if(xmlSecDSigCtxVerify(dsigCtx, node) &#60; 0) {
        fprintf(stderr,"Error: signature verify\n");
	goto done;
    }
        
    /* print verification result to stdout */
    if(dsigCtx-&#62;status == xmlSecDSigStatusSucceeded) {
	fprintf(stdout, "Signature is OK\n");
    } else {
	fprintf(stdout, "Signature is INVALID\n");
    }    

    /* success */
    res = 0;

done:    
    if(dsigCtx != NULL) {
	xmlSecDSigCtxDestroy(dsigCtx);
    }
    
    if(doc != NULL) {
	xmlFreeDoc(doc); 
    }
    return(res);
}
		</PRE
></TD
></TR
></TABLE
><P
><A
HREF="xmlsec-example-dsig4.html"
>Full Program Listing</A
></P
></DIV
>
	</P
><P
>The typical decryption process includes following steps:
	  <P
></P
><UL
><LI
><P
>		Load keys, X509 certificates, etc. in the <A
HREF="xmlsec-keysmngr.html#XMLSECKEYSMNGR"
>keys manager</A
> .
	    </P
></LI
><LI
><P
>		Create encryption context <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTX"
>xmlSecEncCtx</A
>
		using <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXCREATE"
>xmlSecEncCtxCreate</A
> or
		<A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXINITIALIZE"
>xmlSecEncCtxInitialize</A
>
		functions.
	    </P
></LI
><LI
><P
>		Select start decryption &lt;enc:EncryptedData&gt; node.
	    </P
></LI
><LI
><P
>		Decrypt by calling <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXDECRYPT"
>xmlSecencCtxDecrypt</A
> 
		function.
	    </P
></LI
><LI
><P
>		Check returned value and if necessary consume encrypted data.
	    </P
></LI
><LI
><P
>		Destroy encryption context <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTX"
>xmlSecEncCtx</A
>
		using <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXDESTROY"
>xmlSecEncCtxDestroy</A
> or
		<A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXFINALIZE"
>xmlSecEncCtxFinalize</A
>
		functions.
	    </P
></LI
></UL
>
	</P
><P
>	     <DIV
CLASS="EXAMPLE"
><A
NAME="AEN190"
></A
><P
><B
>Example 6. Decrypting a document.</B
></P
><TABLE
BORDER="0"
BGCOLOR="#D8F8D8"
WIDTH="100%"
CELLPADDING="6"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>TODO
		</PRE
></TD
></TR
></TABLE
></DIV
>
	</P
></DIV
><DIV
CLASS="NAVFOOTER"
><BR
CLEAR="all"><BR><TABLE
WIDTH="100%"
BORDER="0"
BGCOLOR="#000000"
CELLPADDING="1"
CELLSPACING="0"
><TR
><TD
WIDTH="25%"
BGCOLOR="#C00000"
ALIGN="left"
><A
HREF="xmlsec-notes-sign-encrypt.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>&#60;&#60;&#60; Previous Page</B
></FONT
></A
></TD
><TD
WIDTH="25%"
BGCOLOR="#0000C0"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
><A
HREF="index.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Home</B
></FONT
></A
></B
></FONT
></TD
><TD
WIDTH="25%"
BGCOLOR="#00C000"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
><A
HREF="xmlsec-notes.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Up</B
></FONT
></A
></B
></FONT
></TD
><TD
WIDTH="25%"
BGCOLOR="#C00000"
ALIGN="right"
><A
HREF="xmlsec-notes-templates.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Next Page &#62;&#62;&#62;</B
></FONT
></A
></TD
></TR
><TR
><TD
COLSPAN="2"
ALIGN="left"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Signing and encrypting documents.</B
></FONT
></TD
><TD
COLSPAN="2"
ALIGN="right"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Creating dynamic templates.</B
></FONT
></TD
></TR
></TABLE
></DIV
></BODY
></HTML
>