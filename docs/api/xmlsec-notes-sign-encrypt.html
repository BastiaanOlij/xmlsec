<HTML
><HEAD
><TITLE
>Signing and encrypting documents.</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.76b+
"><LINK
REL="HOME"
TITLE="XML Security Library Reference Manual"
HREF="index.html"><LINK
REL="UP"
TITLE="XML Security Library Programming Notes"
HREF="xmlsec-notes.html"><LINK
REL="PREVIOUS"
TITLE="Initialization and shutdown."
HREF="xmlsec-notes-init-shutdown.html"><LINK
REL="NEXT"
TITLE="Verifing and decrypting documents."
HREF="xmlsec-notes-verify-decrypt.html"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
BGCOLOR="#000000"
CELLPADDING="1"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="5"
>XML Security Library Reference Manual</FONT
></TH
></TR
><TR
><TD
WIDTH="25%"
BGCOLOR="#C00000"
ALIGN="left"
><A
HREF="xmlsec-notes-init-shutdown.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>&#60;&#60;&#60; Previous Page</B
></FONT
></A
></TD
><TD
WIDTH="25%"
BGCOLOR="#0000C0"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
><A
HREF="index.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Home</B
></FONT
></A
></B
></FONT
></TD
><TD
WIDTH="25%"
BGCOLOR="#00C000"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
><A
HREF="xmlsec-notes.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Up</B
></FONT
></A
></B
></FONT
></TD
><TD
WIDTH="25%"
BGCOLOR="#C00000"
ALIGN="right"
><A
HREF="xmlsec-notes-verify-decrypt.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Next Page &#62;&#62;&#62;</B
></FONT
></A
></TD
></TR
></TABLE
></DIV
><BR
CLEAR="all"><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="XMLSEC-NOTES-SIGN-ENCRYPT"
></A
>Signing and encrypting documents.</H1
><P
>XML Security Library performs signature or encryption by processing 
	input xml or binary data and a template that specifies a signature or 
	encryption skeleton: the transforms, algorithms, the key selection 
	process. A template has the same structure as the desired result but 
	some of the nodes are empty. XML Security Library gets the key for 
	signature/encryption from keys managers using the information from 
	the template, does necessary computations and puts the results in 
	the template. Signature or encryption context controls the whole 
	process and stores the required temporary data.
	  <DIV
CLASS="FIGURE"
><A
NAME="AEN49"
></A
><P
><B
>Figure 2. The signature or encryption processing model.</B
></P
><P
><IMG
SRC="images/sign-enc-model.png"
ALIGN="CENTER"></P
></DIV
>
	</P
><BR
CLEAR="all"><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN52"
></A
>Signing a document.</H2
><P
>The typical siganture process includes following steps:
	  <P
></P
><UL
><LI
><P
>		Prepare data for signature.
	    </P
></LI
><LI
><P
>		Create or load signature template and select start
		&lt;dsig:Signature/&gt; node.
	    </P
></LI
><LI
><P
>		Create signature context <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTX"
>xmlSecDSigCtx</A
>
		using <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXCREATE"
>xmlSecDSigCtxCreate</A
> or
		<A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXINITIALIZE"
>xmlSecDSigCtxInitialize</A
>
		functions.
	    </P
></LI
><LI
><P
>		Load signature key in <A
HREF="xmlsec-keysmngr.html#XMLSECKEYSMNGR"
>keys manager</A
> 
		or generate a sesison key and set it in the signature context 
		(<TT
CLASS="STRUCTFIELD"
><I
>signKey</I
></TT
> member of 
		<A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTX"
>xmlSecDSigCtx</A
> structure).
	    </P
></LI
><LI
><P
>		Sign data by calling <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXSIGN"
>xmlSecDSigCtxSign</A
> 
		function.
	    </P
></LI
><LI
><P
>		Check returned value and consume signed data.
	    </P
></LI
><LI
><P
>		Destroy signature context <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTX"
>xmlSecDSigCtx</A
>
		using <A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXDESTROY"
>xmlSecDSigCtxDestroy</A
> or
		<A
HREF="xmlsec-xmldsig.html#XMLSECDSIGCTXFINALIZE"
>xmlSecDSigCtxFinalize</A
>
		functions.
	    </P
></LI
></UL
>
	</P
><P
>	     <DIV
CLASS="EXAMPLE"
><A
NAME="AEN81"
></A
><P
><B
>Example 3. Signing a template</B
></P
><TABLE
BORDER="0"
BGCOLOR="#D8F8D8"
WIDTH="100%"
CELLPADDING="6"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>int 
sign_file(const char* tmpl_file, const char* key_file) {
    xmlDocPtr doc = NULL;
    xmlNodePtr node = NULL;
    xmlSecDSigCtxPtr dsigCtx = NULL;
    int res = -1;
    
    assert(tmpl_file);
    assert(key_file);

    /* load template */
    doc = xmlParseFile(tmpl_file);
    if ((doc == NULL) || (xmlDocGetRootElement(doc) == NULL)){
	fprintf(stderr, "Error: unable to parse file \"%s\"\n", tmpl_file);
	goto done;	
    }
    
    /* find start node */
    node = xmlSecFindNode(xmlDocGetRootElement(doc), xmlSecNodeSignature, xmlSecDSigNs);
    if(node == NULL) {
	fprintf(stderr, "Error: start node not found in \"%s\"\n", tmpl_file);
	goto done;	
    }

    /* create signature context, we don't need keys manager in this example */
    dsigCtx = xmlSecDSigCtxCreate(NULL);
    if(dsigCtx == NULL) {
        fprintf(stderr,"Error: failed to create signature context\n");
	goto done;
    }

    /* load private key, assuming that there is not password */
    dsigCtx-&#62;signKey = xmlSecCryptoAppPemKeyLoad(key_file, NULL, NULL, 1);
    if(dsigCtx-&#62;signKey == NULL) {
        fprintf(stderr,"Error: failed to load private pem key from \"%s\"\n", key_file);
	goto done;
    }

    /* sign the template */
    if(xmlSecDSigCtxSign(dsigCtx, node) &#60; 0) {
        fprintf(stderr,"Error: signature failed\n");
	goto done;
    }
        
    /* print signed document to stdout */
    xmlDocDump(stdout, doc);
    
    /* success */
    res = 0;

done:    
    if(dsigCtx != NULL) {
	xmlSecDSigCtxDestroy(dsigCtx);
    }
    
    if(doc != NULL) {
	xmlFreeDoc(doc); 
    }
    return(res);
}
		</PRE
></TD
></TR
></TABLE
><P
><A
HREF="xmlsec-example-dsig1.html"
>Full program listing</A
></P
><P
><A
HREF="xmlsec-example-dsig1-tmpl.html"
>Simple signature template file</A
></P
></DIV
>
	</P
></DIV
><BR
CLEAR="all"><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN88"
></A
>Encrypting a document</H2
><P
>The typical encryption process includes following steps:
	  <P
></P
><UL
><LI
><P
>		Prepare data for encryption.
	    </P
></LI
><LI
><P
>		Create or load encryption template and select start
		&lt;enc:EncryptedData/&gt; node.
	    </P
></LI
><LI
><P
>		Create encryption context <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTX"
>xmlSecEncCtx</A
>
		using <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXCREATE"
>xmlSecEncCtxCreate</A
> or
		<A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXINITIALIZE"
>xmlSecEncCtxInitialize</A
>
		functions.
	    </P
></LI
><LI
><P
>		Load encryption key in <A
HREF="xmlsec-keysmngr.html#XMLSECKEYSMNGR"
>keys manager</A
> 
		or generate a sesison key and set it in the encryption context
		(<TT
CLASS="STRUCTFIELD"
><I
>encKey</I
></TT
> member of 
		<A
HREF="xmlsec-xmlenc.html#XMLSECENCCTX"
>xmlSecEncCtx</A
> structure).
	    </P
></LI
><LI
><P
>		Encrypt data by calling one of the following functions:
		<P
></P
><UL
><LI
><P
>			<A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXBINARYENCRYPT"
>xmlSecEncCtxBinaryEncrypt</A
>
		    </P
></LI
><LI
><P
>			<A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXXMLENCRYPT"
>xmlSecEncCtxXmlEncrypt</A
>
		    </P
></LI
><LI
><P
>			<A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXURIENCRYPT"
>xmlSecEncCtxUriEncrypt</A
>
		    </P
></LI
></UL
>
	    </P
></LI
><LI
><P
>		Check returned value and if necessary consume encrypted data.
	    </P
></LI
><LI
><P
>		Destroy encryption context <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTX"
>xmlSecEncCtx</A
>
		using <A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXDESTROY"
>xmlSecEncCtxDestroy</A
> or
		<A
HREF="xmlsec-xmlenc.html#XMLSECENCCTXFINALIZE"
>xmlSecEncCtxFinalize</A
>
		functions.
	    </P
></LI
></UL
>
	</P
><P
>	     <DIV
CLASS="EXAMPLE"
><A
NAME="AEN126"
></A
><P
><B
>Example 4. Encrypting a document.</B
></P
><TABLE
BORDER="0"
BGCOLOR="#D8F8D8"
WIDTH="100%"
CELLPADDING="6"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>TODO
		</PRE
></TD
></TR
></TABLE
></DIV
>
	</P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><BR
CLEAR="all"><BR><TABLE
WIDTH="100%"
BORDER="0"
BGCOLOR="#000000"
CELLPADDING="1"
CELLSPACING="0"
><TR
><TD
WIDTH="25%"
BGCOLOR="#C00000"
ALIGN="left"
><A
HREF="xmlsec-notes-init-shutdown.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>&#60;&#60;&#60; Previous Page</B
></FONT
></A
></TD
><TD
WIDTH="25%"
BGCOLOR="#0000C0"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
><A
HREF="index.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Home</B
></FONT
></A
></B
></FONT
></TD
><TD
WIDTH="25%"
BGCOLOR="#00C000"
ALIGN="center"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
><A
HREF="xmlsec-notes.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Up</B
></FONT
></A
></B
></FONT
></TD
><TD
WIDTH="25%"
BGCOLOR="#C00000"
ALIGN="right"
><A
HREF="xmlsec-notes-verify-decrypt.html"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Next Page &#62;&#62;&#62;</B
></FONT
></A
></TD
></TR
><TR
><TD
COLSPAN="2"
ALIGN="left"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Initialization and shutdown.</B
></FONT
></TD
><TD
COLSPAN="2"
ALIGN="right"
><FONT
COLOR="#FFFFFF"
SIZE="3"
><B
>Verifing and decrypting documents.</B
></FONT
></TD
></TR
></TABLE
></DIV
></BODY
></HTML
>