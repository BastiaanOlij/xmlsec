<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Keys manager.</title>
<meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.76b+
">
<link rel="HOME" title="XML Security Library Reference Manual" href="index.html">
<link rel="UP" title="XML Security Library Programming Notes" href="xmlsec-notes.html">
<link rel="PREVIOUS" title="Keys." href="xmlsec-notes-keys.html">
<link rel="NEXT" title="Transforms and transforms chain." href="xmlsec-notes-transforms.html">
</head>
<body><table witdh="100%" valign="top"><tr valign="top">
<td valign="top" align="left" width="210">
<img src="../images/logo.gif" alt="XML Security Library" border="0"><p></p>
<ul>
<li><a href="../index.html">Home</a></li>
<li><a href="../download.html">Download</a></li>
<li><a href="../news.html">News</a></li>
<li><a href="../documentation.html">Documentation</a></li>
<li><a href="../faq.html">FAQ</a></li>
<li><a href="../xmldsig.html">XML Digital Signature</a></li>
<ul><li><a href="../xmldsig-verifier.html">Online Verifier</a></li></ul>
<li><a href="../xmlenc.html">XML Encryption</a></li>
<li><a href="../c14n.html">XML Canonicalization</a></li>
<li><a href="../bugs.html">Reporting Bugs</a></li>
<li><a href="http://www.aleksey.com/pipermail/xmlsec">Mailing list</a></li>
<li><a href="../related.html">Related</a></li>
</ul>
<a href="http://xmlsoft.org/"><img src="../images/libxml2-logo.png" alt="LibXML2" border="0"></a><br><a href="http://xmlsoft.org/XSLT"><img src="../images/libxslt-logo.png" alt="LibXSLT" border="0"></a><br><a href="http://www.openssl.org/"><img src="../images/openssl-logo.png" alt="OpenSSL" border="0"></a>
</td>
<td valign="top"><table width="100%" valign="top">
<tr><td valign="top" align="left" id="xmlsecContent">
<div class="NAVHEADER"><table width="100%" border="0" bgcolor="#000000" cellpadding="1" cellspacing="0">
<tr><th colspan="4" align="center"><font color="#FFFFFF" size="5">XML Security Library Reference Manual</font></th></tr>
<tr>
<td width="25%" bgcolor="#C00000" align="left"><a href="xmlsec-notes-keys.html"><font color="#FFFFFF" size="3"><b>&lt;&lt;&lt; Previous Page</b></font></a></td>
<td width="25%" bgcolor="#0000C0" align="center"><font color="#FFFFFF" size="3"><b><a href="index.html"><font color="#FFFFFF" size="3"><b>Home</b></font></a></b></font></td>
<td width="25%" bgcolor="#00C000" align="center"><font color="#FFFFFF" size="3"><b><a href="xmlsec-notes.html"><font color="#FFFFFF" size="3"><b>Up</b></font></a></b></font></td>
<td width="25%" bgcolor="#C00000" align="right"><a href="xmlsec-notes-transforms.html"><font color="#FFFFFF" size="3"><b>Next Page &gt;&gt;&gt;</b></font></a></td>
</tr>
</table></div>
<br clear="all"><div class="SECT1">
<h1 class="SECT1">
<a name="XMLSEC-NOTES-KEYSMNGR"></a>Keys manager.</h1>
<p>Processing some of the key data objects require additional 
	information which is global across the application (or in the 
	particular area of the application). For example, X509 certificates 
	processing require a common list of trusted certificates to be 
	available. XML Security Library keeps all the common information 
	for key data processing in a a collection of key data stores called 
	&quot;keys manager&quot;.
    </p>
<div class="FIGURE">
<a name="AEN318"></a><p><b>Figure 7. The keys manager structure.</b></p>
<p><img src="images/keysmngr.png" align="CENTER"></p>
</div>
<p>Keys manager has a special &quot;keys store&quot; which lists the keys 
	known to the application. This &quot;keys store&quot; is used by XML Security 
	Library to lookup keys by name, type and crypto algorithm (for example,
	during 
    	<a href="http://www.w3.org/TR/xmldsig-core/#sec-KeyName" target="_top">&lt;dsig:KeyName/&gt;</a>
	processing). The XML Security Library 
	provides default &quot;flat list&quot; based implementation of a simple keys 
	store. The application can replace it with any other keys store 
	(for example, based on an SQL database).
    </p>
<p>Keys manager is the only object in XML Security Library which 
	is supposed to be shared by many different operations. Usually keys 
	manager is initialized once at the application startup and later is 
	used by XML Security library routines in &quot;read-only&quot; mode. If 
	application or crypto function need to modify any of the key data 
	stores inside keys manager then proper synchronization must be 
	implemented. In the same time, application can create a new keys 
	manager each time it needs to perform XML signature, verification, 
	encryption or decryption.
    </p>
<br clear="all"><div class="SECT2">
<h2 class="SECT2">
<a name="AEN324"></a>Simple keys store.</h2>
<p>XML Security Library has a built-in simple keys store 
	implemented using a keys list. You can use it in your application
	if you have a small number of keys. However, this might be not a 
	best option from performance point of view if you have a lot of keys.
	In this case, you probably should implement your own keys store
	using an SQL database or some other keys storage.
	</p>
<p>	     </p>
<div class="EXAMPLE">
<a name="AEN328"></a><p><b>Example 12. Initializing keys manager and loading public keys from PEM files.</b></p>
<table border="0" bgcolor="#D8F8D8" width="100%" cellpadding="6"><tr><td><pre class="PROGRAMLISTING">/**
 * load_public_keys:
 * @files:		the list of filenames.
 * @files_size:		the number of filenames in #files.
 *
 * Creates simple keys manager and load public keys from #files in it.
 * The caller is responsible for destroing returned keys manager using
 * @xmlSecKeysMngrDestroy.
 *
 * Returns the pointer to newly created keys manager or NULL if an error
 * occurs.
 */
xmlSecKeysMngrPtr 
load_public_keys(char** files, int files_size) {
    xmlSecKeysMngrPtr mngr;
    xmlSecKeyPtr key;
    int i;
    
    assert(files);
    assert(files_size &gt; 0);
    
    /* create and initialize keys manager, we use a simple list based
     * keys manager, implement your own xmlSecKeysStore klass if you need
     * something more sophisticated 
     */
    mngr = xmlSecKeysMngrCreate();
    if(mngr == NULL) {
	fprintf(stderr, &quot;Error: failed to create keys manager.\n&quot;);
	return(NULL);
    }
    if(xmlSecCryptoAppSimpleKeysMngrInit(mngr) &lt; 0) {
	fprintf(stderr, &quot;Error: failed to initialize keys manager.\n&quot;);
	xmlSecKeysMngrDestroy(mngr);
	return(NULL);
    }    
    
    for(i = 0; i &lt; files_size; ++i) {
	assert(files[i]);

	/* load key */
	key = xmlSecCryptoAppPemKeyLoad(files[i], NULL, NULL, 0);
	if(key == NULL) {
    	    fprintf(stderr,&quot;Error: failed to load public pem key from \&quot;%s\&quot;\n&quot;, files[i]);
	    xmlSecKeysMngrDestroy(mngr);
	    return(NULL);
	}

	/* set key name to the file name, this is just an example! */
	if(xmlSecKeySetName(key, BAD_CAST files[i]) &lt; 0) {
    	    fprintf(stderr,&quot;Error: failed to set key name for key from \&quot;%s\&quot;\n&quot;, files[i]);
	    xmlSecKeyDestroy(key);
	    xmlSecKeysMngrDestroy(mngr);
	    return(NULL);
	}
	
	/* add key to keys manager, from now on keys manager is responsible 
	 * for destroying key 
	 */
	if(xmlSecCryptoAppSimpleKeysMngrAdoptKey(mngr, key) &lt; 0) {
    	    fprintf(stderr,&quot;Error: failed to add key from \&quot;%s\&quot; to keys manager\n&quot;, files[i]);
	    xmlSecKeyDestroy(key);
	    xmlSecKeysMngrDestroy(mngr);
	    return(NULL);
	}
    }

    return(mngr);
}
		</pre></td></tr></table>
<p><a href="xmlsec-example-dsig4.html">Full program listing</a></p>
</div>
	<p>	     </p>
<div class="EXAMPLE">
<a name="AEN334"></a><p><b>Example 13. Initializing keys manager and loading DES keys from binary files.</b></p>
<table border="0" bgcolor="#D8F8D8" width="100%" cellpadding="6"><tr><td><pre class="PROGRAMLISTING">/**
 * load_des_keys:
 * @files:		the list of filenames.
 * @files_size:		the number of filenames in #files.
 *
 * Creates simple keys manager and load DES keys from #files in it.
 * The caller is responsible for destroing returned keys manager using
 * @xmlSecKeysMngrDestroy.
 *
 * Returns the pointer to newly created keys manager or NULL if an error
 * occurs.
 */
xmlSecKeysMngrPtr 
load_des_keys(char** files, int files_size) {
    xmlSecKeysMngrPtr mngr;
    xmlSecKeyPtr key;
    int i;
    
    assert(files);
    assert(files_size &gt; 0);
    
    /* create and initialize keys manager, we use a simple list based
     * keys manager, implement your own xmlSecKeysStore klass if you need
     * something more sophisticated 
     */
    mngr = xmlSecKeysMngrCreate();
    if(mngr == NULL) {
	fprintf(stderr, &quot;Error: failed to create keys manager.\n&quot;);
	return(NULL);
    }
    if(xmlSecCryptoAppSimpleKeysMngrInit(mngr) &lt; 0) {
	fprintf(stderr, &quot;Error: failed to initialize keys manager.\n&quot;);
	xmlSecKeysMngrDestroy(mngr);
	return(NULL);
    }    
    
    for(i = 0; i &lt; files_size; ++i) {
	assert(files[i]);

	/* load DES key */
	key = xmlSecKeyReadBinaryFile(xmlSecKeyDataDesId, files[i]);
	if(key == NULL) {
    	    fprintf(stderr,&quot;Error: failed to load des key from binary file \&quot;%s\&quot;\n&quot;, files[i]);
	    xmlSecKeysMngrDestroy(mngr);
	    return(NULL);
	}

	/* set key name to the file name, this is just an example! */
	if(xmlSecKeySetName(key, BAD_CAST files[i]) &lt; 0) {
    	    fprintf(stderr,&quot;Error: failed to set key name for key from \&quot;%s\&quot;\n&quot;, files[i]);
	    xmlSecKeyDestroy(key);
	    xmlSecKeysMngrDestroy(mngr);
	    return(NULL);
	}
	
	/* add key to keys manager, from now on keys manager is responsible 
	 * for destroying key 
	 */
	if(xmlSecCryptoAppSimpleKeysMngrAdoptKey(mngr, key) &lt; 0) {
    	    fprintf(stderr,&quot;Error: failed to add key from \&quot;%s\&quot; to keys manager\n&quot;, files[i]);
	    xmlSecKeyDestroy(key);
	    xmlSecKeysMngrDestroy(mngr);
	    return(NULL);
	}
    }

    return(mngr);
}
		</pre></td></tr></table>
<p><a href="xmlsec-example-enc4.html">Full program listing</a></p>
</div>
	</div>
<br clear="all"><div class="SECT2">
<h2 class="SECT2">
<a name="AEN339"></a>Implementing a custom keys store.</h2>
<p>TODO</p>
<p>	     </p>
<div class="EXAMPLE">
<a name="AEN343"></a><p><b>Example 14. Creating a custom keys manager.</b></p>
<table border="0" bgcolor="#D8F8D8" width="100%" cellpadding="6"><tr><td><pre class="PROGRAMLISTING">/**
 * create_files_keys_mngr:
 *  
 * Creates a files based keys manager: we assume that key name is 
 * the key file name,
 *
 * Returns pointer to newly created keys manager or NULL if an error occurs.
 */
xmlSecKeysMngrPtr 
create_files_keys_mngr(void) {
    xmlSecKeyStorePtr keysStore;
    xmlSecKeysMngrPtr mngr;

    /* create files based keys store */
    keysStore = xmlSecKeyStoreCreate(files_keys_store_get_klass());
    if(keysStore == NULL) {
	fprintf(stderr, &quot;Error: failed to create keys store.\n&quot;);
	return(NULL);
    }
    
    /* create keys manager */
    mngr = xmlSecKeysMngrCreate();
    if(mngr == NULL) {
	fprintf(stderr, &quot;Error: failed to create keys manager.\n&quot;);
	xmlSecKeyStoreDestroy(keysStore);
	return(NULL);
    }

    /* add store to keys manager, from now on keys manager destroys the store if needed */
    if(xmlSecKeysMngrAdoptKeysStore(mngr, keysStore) &lt; 0) {
	fprintf(stderr, &quot;Error: failed to add keys store to keys manager.\n&quot;);
	xmlSecKeyStoreDestroy(keysStore);
	xmlSecKeysMngrDestroy(mngr);
	return(NULL);
    }
    
    /* initialize crypto library specific data in keys manager */
    if(xmlSecCryptoKeysMngrInit(mngr) &lt; 0) {
	fprintf(stderr, &quot;Error: failed to initialize crypto data in keys manager.\n&quot;);
	xmlSecKeysMngrDestroy(mngr);
	return(NULL);
    }

    /* set the get key callback */
    mngr-&gt;getKey = xmlSecKeysMngrGetKey;
    return(mngr);
}

/****************************************************************************
 *
 * Files Keys Store: we assume that key's name (content of the 
 * &lt;dsig:KeyName/&gt; element is a name of the file with a key.
 * Attention: this probably not a good solution for high traffic systems.
 * 
 ***************************************************************************/
static xmlSecKeyPtr		files_keys_store_find_key	(xmlSecKeyStorePtr store,
								 const xmlChar* name,
								 xmlSecKeyInfoCtxPtr keyInfoCtx);
static xmlSecKeyStoreKlass files_keys_store_klass = {
    sizeof(xmlSecKeyStoreKlass),
    sizeof(xmlSecKeyStore),
    BAD_CAST &quot;files-based-keys-store&quot;,	/* const xmlChar* name; */         
    NULL,				/* xmlSecKeyStoreInitializeMethod initialize; */
    NULL,				/* xmlSecKeyStoreFinalizeMethod finalize; */
    files_keys_store_find_key,		/* xmlSecKeyStoreFindKeyMethod findKey; */

    /* reserved for the future */
    NULL,				/* void* reserved0; */
    NULL,				/* void* reserved1; */
};

/**
 * files_keys_store_get_klass:
 * 
 * The files based keys store klass: we assume that key name is the
 * key file name,
 *
 * Returns files based keys store klass.
 */
xmlSecKeyStoreId 
files_keys_store_get_klass(void) {
    return(&amp;files_keys_store_klass);
}

/**
 * files_keys_store_find_key:
 * @store:		the pointer to simple keys store.
 * @name:		the desired key name.
 * @keyInfoCtx:		the pointer to &lt;dsig:KeyInfo/&gt; node processing context.
 *  
 * Lookups key in the @store.
 *
 * Returns pointer to key or NULL if key not found or an error occurs.
 */
static xmlSecKeyPtr
files_keys_store_find_key(xmlSecKeyStorePtr store, const xmlChar* name, xmlSecKeyInfoCtxPtr keyInfoCtx) {
    xmlSecKeyPtr key;
    
    assert(store);
    assert(keyInfoCtx);

    /* it's possible to do not have the key name or desired key type 
     * but we could do nothing in this case */
    if((name == NULL) || (keyInfoCtx-&gt;keyReq.keyId == xmlSecKeyDataIdUnknown)){
	return(NULL);
    }
    
    if((keyInfoCtx-&gt;keyReq.keyId == xmlSecKeyDataDsaId) || (keyInfoCtx-&gt;keyReq.keyId == xmlSecKeyDataRsaId)) {
	/* load key from a pem file, if key is not found then it's an error (is it?) */
	key = xmlSecCryptoAppPemKeyLoad(name, NULL, NULL, 0);
	if(key == NULL) {
    	    fprintf(stderr,&quot;Error: failed to load public pem key from \&quot;%s\&quot;\n&quot;, name);
	    return(NULL);
	}
    } else {
	/* otherwise it's a binary key, if key is not found then it's an error (is it?) */
	key = xmlSecKeyReadBinaryFile(keyInfoCtx-&gt;keyReq.keyId, name);
	if(key == NULL) {
    	    fprintf(stderr,&quot;Error: failed to load key from binary file \&quot;%s\&quot;\n&quot;, name);
	    return(NULL);
	}
    }

    /* set key name */
    if(xmlSecKeySetName(key, name) &lt; 0) {
        fprintf(stderr,&quot;Error: failed to set key name for key from \&quot;%s\&quot;\n&quot;, name);
        xmlSecKeyDestroy(key);
        return(NULL);	
    }

    return(key);
}
		</pre></td></tr></table>
<p><a href="xmlsec-example-enc5.html">Full program listing</a></p>
</div>
	</div>
</div>
<div class="NAVFOOTER">
<br clear="all"><br><table width="100%" border="0" bgcolor="#000000" cellpadding="1" cellspacing="0">
<tr>
<td width="25%" bgcolor="#C00000" align="left"><a href="xmlsec-notes-keys.html"><font color="#FFFFFF" size="3"><b>&lt;&lt;&lt; Previous Page</b></font></a></td>
<td width="25%" bgcolor="#0000C0" align="center"><font color="#FFFFFF" size="3"><b><a href="index.html"><font color="#FFFFFF" size="3"><b>Home</b></font></a></b></font></td>
<td width="25%" bgcolor="#00C000" align="center"><font color="#FFFFFF" size="3"><b><a href="xmlsec-notes.html"><font color="#FFFFFF" size="3"><b>Up</b></font></a></b></font></td>
<td width="25%" bgcolor="#C00000" align="right"><a href="xmlsec-notes-transforms.html"><font color="#FFFFFF" size="3"><b>Next Page &gt;&gt;&gt;</b></font></a></td>
</tr>
<tr>
<td colspan="2" align="left"><font color="#FFFFFF" size="3"><b>Keys.</b></font></td>
<td colspan="2" align="right"><font color="#FFFFFF" size="3"><b>Transforms and transforms chain.</b></font></td>
</tr>
</table>
</div>
</td></tr>
<tr><td>
<br><br><p><a href="/bugs.html">Aleksey Sanin</a></p>
</td></tr>
</table></td>
</tr></table></body>
</html>
