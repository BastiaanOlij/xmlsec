    <sect1 id="xmlsec-notes-sign-encrypt">
      <title>Signing and encrypting documents.</title>
	<para>XML Security Library performs signature or encryption by processing 
	input xml or binary data and a template that specifies a signature or 
	encryption skeleton: the transforms, algorithms, the key selection 
	process. A template has the same structure as the desired result but 
	some of the nodes are empty. XML Security Library gets the key for 
	signature/encryption from keys managers using the information from 
	the template, does necessary computations and puts the results in 
	the template. Signature or encryption context controls the whole 
	process and stores the required temporary data.
	  <figure>
	    <title>The signature or encryption processing model.</title>
	    <graphic fileref="images/sign-enc-model.png" align="center" />
	  </figure>
	</para>
	<sect2>
	<title>Signing a document.</title>
	<para>The typical siganture process includes following steps:
	  <itemizedlist>
	    <listitem><para>
		Prepare data for signature.
	    </para></listitem>
	    <listitem><para>
		Create or load signature template and select start
		&lt;dsig:Signature/&gt; node.
	    </para></listitem>
	    <listitem><para>
		Create signature context <link linkend="xmlSecDSigCtx">xmlSecDSigCtx</link>
		using <link linkend="xmlSecDSigCtxCreate">xmlSecDSigCtxCreate</link> or
		<link linkend="xmlSecDSigCtxInitialize">xmlSecDSigCtxInitialize</link>
		functions.
	    </para></listitem>
	    <listitem><para>
		Load signature key in <link linkend="xmlSecKeysMngr">keys manager</link> 
		or generate a sesison key and set it in the signature context 
		(<structfield>signKey</structfield> member of 
		<link linkend="xmlSecDSigCtx">xmlSecDSigCtx</link> structure).
	    </para></listitem>
	    <listitem><para>
		Sign data by calling <link linkend="xmlSecDSigCtxSign">xmlSecDSigCtxSign</link> 
		function.
	    </para></listitem>
	    <listitem><para>
		Check returned value and consume signed data.
	    </para></listitem>
	    <listitem><para>
		Destroy signature context <link linkend="xmlSecDSigCtx">xmlSecDSigCtx</link>
		using <link linkend="xmlSecDSigCtxDestroy">xmlSecDSigCtxDestroy</link> or
		<link linkend="xmlSecDSigCtxFinalize">xmlSecDSigCtxFinalize</link>
		functions.
	    </para></listitem>
	  </itemizedlist>
	</para>
	<para>
	     <example>
		<title>Signing a template</title>
		<programlisting><![CDATA[
int 
sign_file(const char* tmpl_file, const char* key_file) {
    xmlDocPtr doc = NULL;
    xmlNodePtr node = NULL;
    xmlSecDSigCtxPtr dsigCtx = NULL;
    int res = -1;
    
    assert(tmpl_file);
    assert(key_file);

    /* load template */
    doc = xmlParseFile(tmpl_file);
    if ((doc == NULL) || (xmlDocGetRootElement(doc) == NULL)){
	fprintf(stderr, "Error: unable to parse file \"%s\"\n", tmpl_file);
	goto done;	
    }
    
    /* find start node */
    node = xmlSecFindNode(xmlDocGetRootElement(doc), xmlSecNodeSignature, xmlSecDSigNs);
    if(node == NULL) {
	fprintf(stderr, "Error: start node not found in \"%s\"\n", tmpl_file);
	goto done;	
    }

    /* create signature context, we don't need keys manager in this example */
    dsigCtx = xmlSecDSigCtxCreate(NULL);
    if(dsigCtx == NULL) {
        fprintf(stderr,"Error: failed to create signature context\n");
	goto done;
    }

    /* load private key, assuming that there is not password */
    dsigCtx->signKey = xmlSecCryptoAppPemKeyLoad(key_file, NULL, NULL, 1);
    if(dsigCtx->signKey == NULL) {
        fprintf(stderr,"Error: failed to load private pem key from \"%s\"\n", key_file);
	goto done;
    }

    /* sign the template */
    if(xmlSecDSigCtxSign(dsigCtx, node) < 0) {
        fprintf(stderr,"Error: signature failed\n");
	goto done;
    }
        
    /* print signed document to stdout */
    xmlDocDump(stdout, doc);
    
    /* success */
    res = 0;

done:    
    if(dsigCtx != NULL) {
	xmlSecDSigCtxDestroy(dsigCtx);
    }
    
    if(doc != NULL) {
	xmlFreeDoc(doc); 
    }
    return(res);
}
		]]></programlisting>
	    <para><link linkend="xmlsec-example-dsig1">Full program listing</link></para>
	    <para><link linkend="xmlsec-example-dsig1-tmpl">Simple signature template file</link></para>
	    </example>
	</para>
	</sect2>
	<sect2>
	<title>Encrypting a document</title>
	<para>The typical encryption process includes following steps:
	  <itemizedlist>
	    <listitem><para>
		Prepare data for encryption.
	    </para></listitem>
	    <listitem><para>
		Create or load encryption template and select start
		&lt;enc:EncryptedData/&gt; node.
	    </para></listitem>
	    <listitem><para>
		Create encryption context <link linkend="xmlSecEncCtx">xmlSecEncCtx</link>
		using <link linkend="xmlSecEncCtxCreate">xmlSecEncCtxCreate</link> or
		<link linkend="xmlSecEncCtxInitialize">xmlSecEncCtxInitialize</link>
		functions.
	    </para></listitem>
	    <listitem><para>
		Load encryption key in <link linkend="xmlSecKeysMngr">keys manager</link> 
		or generate a sesison key and set it in the encryption context
		(<structfield>encKey</structfield> member of 
		<link linkend="xmlSecEncCtx">xmlSecEncCtx</link> structure).
	    </para></listitem>
	    <listitem><para>
		Encrypt data by calling one of the following functions:
		<itemizedlist>
		    <listitem><para>
			<link linkend="xmlSecEncCtxBinaryEncrypt">xmlSecEncCtxBinaryEncrypt</link>
		    </para></listitem>
		    <listitem><para>
			<link linkend="xmlSecEncCtxXmlEncrypt">xmlSecEncCtxXmlEncrypt</link>
		    </para></listitem>
		    <listitem><para>
			<link linkend="xmlSecEncCtxUriEncrypt">xmlSecEncCtxUriEncrypt</link>
		    </para></listitem>
		</itemizedlist>
	    </para></listitem>
	    <listitem><para>
		Check returned value and if necessary consume encrypted data.
	    </para></listitem>
	    <listitem><para>
		Destroy encryption context <link linkend="xmlSecEncCtx">xmlSecEncCtx</link>
		using <link linkend="xmlSecEncCtxDestroy">xmlSecEncCtxDestroy</link> or
		<link linkend="xmlSecEncCtxFinalize">xmlSecEncCtxFinalize</link>
		functions.
	    </para></listitem>
	  </itemizedlist>
	</para>
	<para>
	     <example>
		<title>Encrypting a document.</title>
		<programlisting><![CDATA[
TODO
		]]></programlisting>
	    </example>
	</para>
	</sect2>
    </sect1>
	
